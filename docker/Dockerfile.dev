FROM golang:1.25-trixie AS golang
FROM debian:trixie

# Declare ARG to make it available in the RUN commands
ARG TARGETPLATFORM
RUN echo "Building for ${TARGETPLATFORM}"
RUN if [ "${TARGETPLATFORM}" != "linux/amd64" ] && [ "${TARGETPLATFORM}" != "linux/arm64" ]; then \
        echo "Unsupported architecture: ${TARGETPLATFORM}" && \
        exit 1; \
    fi

WORKDIR /app
ENV DEBIAN_FRONTEND="noninteractive"
ENV GOBIN="/usr/local/go/bin"
ENV PATH="$PATH:/usr/local/go/bin"

# Install golang from docker image
COPY --from=golang /usr/local/go /usr/local/go

# Install system dependencies and prepare system
RUN set -e && \
    # Create a temp dir for downloads
    mkdir /tmp/downloads && cd /tmp/downloads && \
    
    # Add PostgreSQL APT repository
    # https://www.postgresql.org/download/linux/debian/
    apt update && apt install -y postgresql-common && \
    /usr/share/postgresql-common/pgdg/apt.postgresql.org.sh -y && \
    
    # Add ClickHouse repository
    # https://clickhouse.com/docs/en/install#install-from-deb-packages
    apt install -y apt-transport-https ca-certificates gnupg && \
    mkdir -p /usr/share/keyrings && \
    wget -qO- https://clickhouse.com/static/public.key | gpg --dearmor > /usr/share/keyrings/clickhouse-keyring.gpg && \
    echo "deb [signed-by=/usr/share/keyrings/clickhouse-keyring.gpg] https://packages.clickhouse.com/deb stable main" | tee /etc/apt/sources.list.d/clickhouse.list && \
    
    # Install APT packages
    apt update && apt install -y \
        wget unzip tzdata git curl xz-utils \
        postgresql-client-13 postgresql-client-14 \
        postgresql-client-15 postgresql-client-16 \
        postgresql-client-17 postgresql-client-18 \
        clickhouse-client && \
    
    # Install clickhouse-backup (separate tool, not in official repo)
    # https://github.com/Altinity/clickhouse-backup
    if [ "${TARGETPLATFORM}" = "linux/arm64" ]; then \
        wget --no-verbose https://github.com/Altinity/clickhouse-backup/releases/download/v2.6.0/clickhouse-backup-linux-arm64.tar.gz -O /tmp/clickhouse-backup.tar.gz && \
        tar -xzf /tmp/clickhouse-backup.tar.gz -C /tmp && \
        mv /tmp/clickhouse-backup /usr/local/bin/clickhouse-backup && \
        chmod +x /usr/local/bin/clickhouse-backup; \
    else \
        wget --no-verbose https://github.com/Altinity/clickhouse-backup/releases/download/v2.6.0/clickhouse-backup-linux-amd64.tar.gz -O /tmp/clickhouse-backup.tar.gz && \
        tar -xzf /tmp/clickhouse-backup.tar.gz -C /tmp && \
        mv /tmp/clickhouse-backup /usr/local/bin/clickhouse-backup && \
        chmod +x /usr/local/bin/clickhouse-backup; \
    fi && \
    
    # Install NodeJS 22.19.0
    # Download and install Node.js binary directly
    if [ "${TARGETPLATFORM}" = "linux/arm64" ]; then \
        NODE_ARCH="arm64"; \
    else \
        NODE_ARCH="x64"; \
    fi && \
    NODE_VERSION="22.19.0" && \
    wget --no-verbose https://nodejs.org/dist/v${NODE_VERSION}/node-v${NODE_VERSION}-linux-${NODE_ARCH}.tar.xz -O /tmp/node.tar.xz && \
    tar -xJf /tmp/node.tar.xz -C /tmp && \
    mv /tmp/node-v${NODE_VERSION}-linux-${NODE_ARCH} /usr/local/node && \
    ln -sf /usr/local/node/bin/node /usr/local/bin/node && \
    ln -sf /usr/local/node/bin/npm /usr/local/bin/npm && \
    ln -sf /usr/local/node/bin/npx /usr/local/bin/npx && \
    rm /tmp/node.tar.xz && \

    # Install downloadable binaries
    if [ "${TARGETPLATFORM}" = "linux/arm64" ]; then \
        echo "Downloading arm64 binaries" && \
        # Install task
        wget --no-verbose https://github.com/go-task/task/releases/download/v3.45.4/task_linux_arm64.tar.gz && \
        tar -xzf task_linux_arm64.tar.gz && \
        mv ./task /usr/local/bin/task && \
        # Install goose
        wget --no-verbose https://github.com/pressly/goose/releases/download/v3.25.0/goose_linux_arm64 && \
        mv ./goose_linux_arm64 /usr/local/bin/goose && \
        # Install sqlc
        wget --no-verbose https://github.com/sqlc-dev/sqlc/releases/download/v1.30.0/sqlc_1.30.0_linux_arm64.tar.gz && \
        tar -xzf sqlc_1.30.0_linux_arm64.tar.gz && \
        mv ./sqlc /usr/local/bin/sqlc && \
        # Install golangci-lint
        wget --no-verbose https://github.com/golangci/golangci-lint/releases/download/v2.5.0/golangci-lint-2.5.0-linux-arm64.tar.gz && \
        tar -xzf golangci-lint-2.5.0-linux-arm64.tar.gz && \
        mv ./golangci-lint-2.5.0-linux-arm64/golangci-lint /usr/local/bin/golangci-lint; \
    else \
        echo "Downloading amd64 binaries" && \
        # Install task
        wget --no-verbose https://github.com/go-task/task/releases/download/v3.45.4/task_linux_amd64.tar.gz && \
        tar -xzf task_linux_amd64.tar.gz && \
        mv ./task /usr/local/bin/task && \
        # Install goose
        wget --no-verbose https://github.com/pressly/goose/releases/download/v3.25.0/goose_linux_x86_64 && \
        mv ./goose_linux_x86_64 /usr/local/bin/goose && \
        # Install sqlc
        wget --no-verbose https://github.com/sqlc-dev/sqlc/releases/download/v1.30.0/sqlc_1.30.0_linux_amd64.tar.gz && \
        tar -xzf sqlc_1.30.0_linux_amd64.tar.gz && \
        mv ./sqlc /usr/local/bin/sqlc && \
        # Install golangci-lint
        wget --no-verbose https://github.com/golangci/golangci-lint/releases/download/v2.5.0/golangci-lint-2.5.0-linux-amd64.tar.gz && \
        tar -xzf golangci-lint-2.5.0-linux-amd64.tar.gz && \
        mv ./golangci-lint-2.5.0-linux-amd64/golangci-lint /usr/local/bin/golangci-lint; \
    fi && \

    # Make downloaded binaries executable
    chmod +x /usr/local/bin/* && \

    # Default git config
    # https://github.com/golangci/golangci-lint/issues/4033
    git config --global --add safe.directory '*' && \

    # Clean up downloads and APT cache
    mkdir -p /app && cd /app && rm -rf /tmp/downloads && \
    rm -rf /var/lib/apt/lists/* && \

    # Create backups dir
    mkdir /backups && \
    chmod 777 /backups && \
    true

##############
# START HERE #
##############

# Add the startup script on every bash session
RUN rm -rf /root/.bashrc
COPY .devcontainer/.bashrc /root/.bashrc

# Command just to keep the container running
CMD ["sleep", "infinity"]
